# StockKLineApp 需求规格说明（SPEC）

## 1. 项目结构

```text
/src
  /StockKLineApp (WPF)
    /Models
    /Services
    /ViewModels
    /Views
    /Controls
/tests
  /StockKLineApp.Tests
SPEC.md
```

---

## 2. 输入数据规范（CSV）

### 2.1 必需列
CSV 文件必须包含以下列（列名按中文/英文兼容，建议在实现中做别名映射）：

- 股票代码
- 名称
- symbol
- 日期
- 今开
- 今末
- 最高
- 最低
- 成交额（单位：万，最多 6 位小数）

### 2.2 数据特性与兼容要求
为提高兼容性，CSV 解析需从第一版就防御以下情况：

1. **日期格式可能不统一**
   - 支持 `YYYY-MM-DD`
   - 支持 `YYYYMMDD`
   - 内部统一转换为 `DateOnly` / `DateTime`（仅日期维度）

2. **文件编码不统一**
   - 支持 UTF-8（含/不含 BOM）
   - 支持 GBK
   - 建议解析策略：优先 UTF-8，失败后回退 GBK，并在日志中记录采用的编码

3. **数值字段可能空值/缺失**
   - 涉及字段：今开、今末、最高、最低、成交额（单位：万）
   - 默认策略：
     - 必需价格字段（开/收/高/低）缺失时，该行判定为无效行并进入错误收集
     - 成交额缺失可按 `null` 处理，不阻断整行导入
     - 成交额非空时最多允许 6 位小数

4. **单个 CSV 可能包含多只股票**
   - 同一文件可包含多只股票、多日期记录
   - 系统必须按「股票代码（或 symbol）」进行分组索引
   - UI 搜索和详情页基于分组后的股票实体工作

### 2.3 校验与错误提示（必须）
解析失败时必须提供明确错误信息：

- 第几行（1-based，含表头说明）
- 哪一列（列名 + 列索引）
- 原始值
- 错误原因（如格式非法、必填缺失、越界）

建议错误格式：

```text
CSV 解析失败：第 128 行，第 6 列（今末），值 "N/A"，无法解析为 decimal。
```

---

## 3. 功能需求

### 3.1 打开 CSV
- 提供菜单项或按钮触发「打开 CSV」
- 支持选择本地 `.csv` 文件
- 导入后在内存中生成股票数据集合与索引

### 3.2 主界面搜索
- 主界面提供搜索框
- 支持按以下条件模糊搜索：
  - 股票代码
  - 名称
- 搜索结果实时过滤或按确认触发过滤均可，但应保证响应及时

### 3.3 股票详情页跳转
- 在主界面选中某只股票后，进入该股票详情页
- 详情页展示该股票完整时间序列（按日期排序）

### 3.4 详情页展示内容
1. **K 线图（OHLC）**
   - 展示开盘、最高、最低、收盘

2. **时间范围条（Range Bar / Slider）**
   - 位于 K 线图下方
   - 支持拖动起止端点以调整可视区间
   - 拖动后主图显示区间实时更新

3. **当前区间日期显示**
   - 在详情页明显位置显示当前可视区间起止日期
   - 日期格式统一（建议 `yyyy-MM-dd`）

---

## 4. 非功能需求

1. **性能**
   - 在 5 年日线数据量级下，时间范围拖动应保持流畅
   - 最低要求：交互过程中不出现明显卡顿（“不卡成 PPT”）

2. **稳定性与可诊断性**
   - CSV 解析过程出现异常时，必须给出可定位的错误信息（行/列/值/原因）
   - 不允许仅提示笼统“导入失败”

---

## 5. 建议实现要点（供开发时参考）

- 解析层：
  - 建立列名映射表（中英文别名）
  - 对日期与编码做双通道兼容
  - 使用统一的 `ParseResult`/`ValidationError` 模型承载错误细节
- 数据层：
  - 以 `股票代码 + symbol` 作为稳定键（可按业务再细化）
  - 每只股票持有按日期升序的 K 线集合
- 视图模型层：
  - 搜索关键字变更时进行过滤
  - 详情页维护「全量数据 + 当前窗口数据」
- 渲染与交互：
  - Range Bar 改变时仅刷新可视窗口，避免整图全量重算
